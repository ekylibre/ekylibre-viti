- analysis = resource.analysis
- tavp_item = analysis&.items&.find_by(indicator_name: :estimated_harvest_alcoholic_volumetric_concentration)

- main_toolbar do |t|
  = t.edit resource
  - if analysis
    = link_to :edit_analysis.tl, { controller: :analyses, action: :edit, id: analysis.id } , { class: 'btn btn-default icn btn-edit'}

= main_informations attachment: true do
  = infos do
    .med-info.important
      %span.title= :incoming_harvest_quantity.tl
      %span.value= resource.quantity.round_l
    - if tavp_item
      .med-info.important
        %span.title= Nomen::Indicator.find(:estimated_harvest_alcoholic_volumetric_concentration).human_name
        %span.value= tavp_item.value.round_l

  = attributes_list(resource) do |l|
    - l.attribute :number
    - l.attribute :ticket_number
    - l.attribute :received_at
    - l.attribute :analysis, url: true

= cobbles do |c|
  - c.cobble(:plants, title: :harvested_plants.tl) do
    = cobble_list(:plants)

  - c.cobble(:storages, title: :winery_destination.tl) do
    = cobble_list(:storages)

  - c.cobble(:presses, title: :winery_press.tl) do
    = cobble_list(:presses)

  - if analysis
    - c.cobble(:analysis) do
      / TODO: Dirty, would need to spend more time to have a proper behavior handled by attributes_list helper
      .attributes-list
        - analysis.items.each do |item|
          %dl
            %dt= Nomen::Indicator.find(item.indicator_name).human_name
            %dd= Maybe(attribute_item(item, :value).last).or_else { '-' }

  - unless resource.additional_informations.empty?
    - c.cobble(:additional_informations) do
      = attributes_list(resource, stamps: false) do |l|
        - l.attribute :harvest_description
        - l.custom WineIncomingHarvest.human_attribute_name(:sedimentation_duration), resource.sedimentation_duration.present? ? "#{resource.sedimentation_duration} min" : '-'
        - l.attribute :vehicle_trailer
        - l.custom WineIncomingHarvest.human_attribute_name(:harvest_transportation_duration), resource.harvest_transportation_duration.present? ? "#{resource.harvest_transportation_duration} min" : '-'
        - l.custom WineIncomingHarvest.human_attribute_name(:last_load), resource.last_load ? { true: :y.tl, false: :n.tl }[resource.last_load.to_sym] : '-'
        - l.custom WineIncomingHarvest.human_attribute_name(:harvest_nature), resource.harvest_nature.present? ? resource.harvest_nature.tl : '-'
        - l.attribute :harvest_dock